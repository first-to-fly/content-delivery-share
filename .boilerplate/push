#!/usr/bin/env bash

# shellcheck disable=SC1090
source "${BASH_SOURCE[0]%/*}/../lib/bash/core.sh"

function pushBranch() {

  BRANCH="${1:-}"

  BRANCH_FILTER="^${BRANCH}-.*$"
  if [[ "${BRANCH}" == "master" ]]; then
    BRANCH_FILTER='^[a-z0-9]\+$'
  fi

  git branch --list --remote |
    grep "origin" |
    sed 's|^.*origin/||' |
    grep --invert-match "^${BRANCH}\$" |
    grep "${BRANCH_FILTER}" |
    while IFS='' read -r TO_BRANCH; do

      echo
      echo "Pushing ${BRANCH} => ${TO_BRANCH}..."

      TEMP_DIR="$(mktemp -d)"

      (
        set -x
        git clone \
          --branch "${TO_BRANCH}" \
          --recurse-submodules \
          "${GIT_REMOTE_URL}" \
          "${TEMP_DIR}"
      )

      GIT_MERGE_OUTPUT="$(git merge "origin/${BRANCH}")"
      if [[ "${GIT_MERGE_OUTPUT}" == *"CONFLICT"* ]]; then
        echo "${GIT_MERGE_OUTPUT}" >&2
        echo "Please resolve the conflict and press Return to continue..." >&2
        stree "${TEMP_DIR}"
        read -r
      fi

      pushBranch "${TO_BRANCH}"

    done
}

function main() {

  echo -e "${OK_COLOR}==> Pushing published changes from current branch to others..."

  GIT_REMOTE_URL="$(git config --get remote.origin.url)"
  if [[ "${GIT_REMOTE_URL}" != *"bitbucket.org/nabstudio/boilerplates.git" ]]; then
    echo "This script can only run in the boilerplate project." >&2
    return 1
  fi

  GIT_STATUS="$(git status --short --porcelain)"
  if [[ -n "${GIT_STATUS}" ]]; then
    echo "There are uncommitted changes. Please commit them before continue." >&2
    echo >&2
    echo "${GIT_STATUS}" >&2
    # return 1
  fi

  GIT_BRANCH="$(git branch -vv | grep "\*" | awk '{print $2}')"
  GIT_UNPUSHED_COMMITS="$(git log "origin/${GIT_BRANCH}..HEAD")"
  if [[ -n "${GIT_UNPUSHED_COMMITS}" ]]; then
    echo "There are unpushed commits. Please push them before continue." >&2
    echo >&2
    echo "${GIT_UNPUSHED_COMMITS}" >&2
    # return 1
  fi

  pushBranch "${GIT_BRANCH}"

}

main "$@" ||
  catch "$?" &&
  finally
