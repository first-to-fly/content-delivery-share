#!/usr/bin/env bash

source "${BASH_SOURCE[0]%/*}/../lib/bash/core.sh"

function main() {

  echo -e "${OK_COLOR}==> Upgrading boilerplate..."

  local REMOTE_URL="https://bitbucket.org/nabstudio/boilerplates.git"

  # Get Branch
  local BRANCH

  local CONFIG_FILE="./.boilerplate/config.json"
  if [[ -f "${CONFIG_FILE}" ]]; then
    BRANCH="$(jq --raw-output ".branch" "${CONFIG_FILE}")"
  fi

  if [[ -z "${BRANCH:-}" || "${BRANCH:-}" == "null" ]]; then

    echo "Available boilerplates:"
    git ls-remote "${REMOTE_URL}" | awk '{print $2}' | grep '^refs/' | sed 's|^refs/heads/|- |'

    echo "Which do you want to use? (master) "
    read -r BRANCH
    if [[ -z "${BRANCH:-}" ]]; then
      BRANCH="master"
    fi

    echo "Using ${COLOR_GREEN}${BRANCH}${NO_COLOR}..."

    if [[ -f "${CONFIG_FILE}" ]]; then
      local NEW_CONFIG
      NEW_CONFIG="$(jq --raw-output ".branch = \"${BRANCH}\"" "${CONFIG_FILE}")"
      echo "${NEW_CONFIG}" >"${CONFIG_FILE}"
    fi
  fi

  #
  if [[ -d "./.git" ]]; then
    # Current folder is Git root

    # "z" to keep remote at the bottom
    # to prevent auto-push
    local REMOTE_NAME="zboilerplate"

    if ! git remote -v | grep "${REMOTE_NAME}" >/dev/null; then
      (
        set -x
        git remote add \
          "${REMOTE_NAME}" \
          "${REMOTE_URL}"
      )
    fi

    (
      set -x
      git fetch \
        --tags \
        --prune \
        "${REMOTE_NAME}"
    )

    (
      set -x
      git merge \
        --allow-unrelated-histories \
        "${REMOTE_NAME}/${BRANCH}"
    )

    (
      set -x
      git submodule update \
        --init \
        --recursive
    )

    (
      set -x
      git remote remove \
        "${REMOTE_NAME}"
    )

  else
    # Current folder is not Git root -> Git subtree

    local GIT_ROOT
    GIT_ROOT="$(git rev-parse --show-toplevel)"

    local SUBTREE_PREFIX="${PWD/#"${GIT_ROOT}"\//}"

    (
      set -x

      cd "${GIT_ROOT}" || return 1

      git subtree pull \
        --squash \
        --prefix "${SUBTREE_PREFIX}" \
        "${REMOTE_URL}" \
        "${BRANCH}" || (

        rm -rf "${SUBTREE_PREFIX}" &&
          git subtree add \
            --prefix "${SUBTREE_PREFIX}" \
            "${REMOTE_URL}" \
            "${BRANCH}" &&
          git subtree pull \
            --squash \
            --prefix "${SUBTREE_PREFIX}" \
            "${REMOTE_URL}" \
            "${BRANCH}"
      )

    )

  fi

}

main "$@"
