#!/usr/bin/env bash

source "./lib/bash/core.sh"
source "./lib/bash/node.sh"

function main() {

  local SCRIPT="dev"
  if [[ -n "${1:-}" ]] && jq --exit-status ".scripts.${1:-}" "./package.json" >/dev/null 2>/dev/null; then
    SCRIPT="${1}"
    shift
  fi

  if [[ ! -d "./node_modules" ]]; then
    "./pipeline/install"
  fi

  echo -e "${OK_COLOR}==> Debugging app..."

  NODE_DEBUG_PORT="${NODE_DEBUG_PORT:-9229}"
  (lsof -t -i ":${NODE_DEBUG_PORT}" || true) |
    xargs kill

  # Kill old processes
  # shellcheck disable=SC2009
  ps |
    grep --invert-match "grep" |
    (grep "nodemon" || true) |
    awk '{print $1}' |
    xargs kill

  loadEnvKey

  NPM="$(command -v npm)"

  (
    set -x
    "${NPM}" run "${SCRIPT}" "$@"
  )

}

main "$@"
