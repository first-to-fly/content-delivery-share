#!/usr/bin/env bash

source "${BASH_SOURCE[0]%/*}/../lib/bash/core.sh"

function main() {

  FILE="${1:-}"

  if [[ -z "${FILE}" ]]; then

    find . \
      -type f \
      \( \
      -iname "*.css" \
      -o \
      -iname "*.scss" \
      -o \
      -iname "*.less" \
      -o \
      -iname "*.sss" \
      \) |
      while IFS= read -r OTHER_FILE; do
        echo "${OTHER_FILE}"
      done

    return
  fi

  if [[ ! -d "./node_modules/node-sass" ]]; then
    NPM="$(command -v npm)"
    (
      set -x
      "${NPM}" install --no-save "node-sass"
    )
  fi

  NPX="$(command -v npx)"

  (
    set -x
    "${NPX}" tsm "${FILE}"
  )

  HEADER_FILE="${FILE}.d.ts"

  if [[ -f "${HEADER_FILE}" ]]; then

    CONTENT="$(cat "${HEADER_FILE}")"
    echo "/* eslint-disable import/prefer-default-export */" >"${HEADER_FILE}"
    echo "${CONTENT}" >>"${HEADER_FILE}"

    (
      set -x

      "${NPX}" prettier \
        --write \
        "${HEADER_FILE}"

      "${NPX}" eslint \
        --fix \
        --no-ignore \
        "${HEADER_FILE}"
    )

  fi

}

main "$@"
