#!/usr/bin/env bash

# shellcheck disable=SC1090
source "${BASH_SOURCE[0]%/*}/lib/core.sh"

function main() {

  FILE="${1:-}"

  if [[ -z "${FILE}" ]]; then

    find . \
      -type f \
      \( \
      -iname "*.css" \
      -o \
      -iname "*.scss" \
      -o \
      -iname "*.less" \
      -o \
      -iname "*.sss" \
      \) |
      while IFS= read -r OTHER_FILE; do
        echo "${OTHER_FILE}"
      done

    return
  fi

  if [[ -d "./node_modules" ]]; then
    PATH="${PWD}/node_modules/.bin:${PATH}"
  fi

  (
    set -x
    tsm "${FILE}"
  )

  HEADER_FILE="${FILE}.d.ts"

  if [[ -f "${HEADER_FILE}" ]]; then

    CONTENT="$(cat "${HEADER_FILE}")"
    echo "/* eslint-disable import/prefer-default-export */" >"${HEADER_FILE}"
    echo "${CONTENT}" >>"${HEADER_FILE}"

    (
      set -x

      prettier \
        --write \
        "${HEADER_FILE}"

      eslint \
        --fix \
        --no-ignore \
        "${HEADER_FILE}"
    )

  fi

}

main "$@" ||
  catch "$?" &&
  finally
