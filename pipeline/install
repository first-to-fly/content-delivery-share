#!/usr/bin/env bash

# shellcheck source=./lib/bash/core.sh
source "${BASH_SOURCE[0]%/*}/../lib/bash/core.sh"

# shellcheck source=./lib/bash/node.sh
source "${BASH_SOURCE[0]%/*}/../lib/bash/node.sh"

function main() {

  local PRODUCTION="false"
  if [[ "$*" == *"--production"* ]]; then
    PRODUCTION="true"
  fi

  if [[ "${HOME:-}" == "/vercel" ]]; then
    (
      set -x
      rm -rf "./node_modules"
      rm -rf "./submodules/"*"/node_modules"
    )
  fi

  echo -e "${OK_COLOR}==> Installing dependencies..."

  (
    set -x
    npm install --global "npm@latest" ||
      npm install --global "npm@latest" ||
      true
    npm --version || true
  )

  # Fix git+ssh "unsupported option accept-new"
  # See https://github.com/npm/git/issues/31#issuecomment-862267072
  export GIT_SSH_COMMAND="ssh"

  if [[ -n "${BITBUCKET_USERNAME:-}" && -n "${BITBUCKET_PASSWORD:-}" ]]; then
    echo "Setting up Git for BitBucket..."
    (
      # set -x
      git config --global url."https://${BITBUCKET_USERNAME}:${BITBUCKET_PASSWORD}@bitbucket.org/".insteadOf "ssh://git@bitbucket.org/"
      git config --global url."https://${BITBUCKET_USERNAME}:${BITBUCKET_PASSWORD}@bitbucket.org/".insteadOf "git@bitbucket.org:"
      git config --global url."https://${BITBUCKET_USERNAME}:${BITBUCKET_PASSWORD}@bitbucket.org/".insteadOf "https://bitbucket.org/"
    )
  fi

  local LOCK_FILE_VERSION
  LOCK_FILE_VERSION="$(jq --raw-output '.lockfileVersion' "./package-lock.json")"
  if [[ "${LOCK_FILE_VERSION}" == "1" ]]; then
    echo "package-lock.json is outdated and at version 1. Removing file..."
    (
      set -x
      rm -rf "./package-lock.json"
    )
  fi

  NPM="$(command -v npm)"

  (
    set -x
    # "--force" accepts dependency conflict
    "${NPM}" install \
      --force \
      "$@" ||
      "${NPM}" install \
        --force \
        "$@"
  )

  if [[ "${PRODUCTION}" != "true" ]]; then
    (
      set -x
      "${NPM}" audit || true
    )
  fi

}

main "$@"
